<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMINA - Garden</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #faf9f6; color: #44403c; overflow: hidden; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tree-transition { transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .item-float { animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translate(-50%, -52%) scale(1); } 50% { transform: translate(-50%, -48%) scale(1.05); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icons = {
            ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Camera: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Plus: () => <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
            ChevronDown: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        };

        const TreeGraphic = ({ entries = [], size = "large" }) => {
            const count = entries.length;
            const scale = count >= 10 ? 1.15 : count >= 5 ? 1.08 : 1.0;
            return (
                <div className="flex justify-center tree-transition" style={{ transform: `scale(${scale})`, transformOrigin: 'bottom' }}>
                    <svg width={size === "small" ? 48 : 260} height={size === "small" ? 34 : 160} viewBox="0 0 200 120">
                        <path d="M92 120 Q100 118 100 105 T108 120" fill="#D6D3D1" />
                        <path d="M10 85 Q10 25 100 15 T190 85 Q190 100 100 105 T10 85" fill={count > 0 ? "#34d399" : "#f1f5f9"} opacity="0.8" />
                        <path d="M100 100 L100 60 M100 90 L50 75 M100 85 L150 70 M100 80 L75 45 M100 75 L125 40" stroke="#fff" strokeWidth="0.8" opacity="0.3" fill="none" />
                    </svg>
                </div>
            );
        };

        function App() {
            const apiRoot = window.location.origin.startsWith('blob') ? '' : window.location.origin;
            const params = new URLSearchParams(window.location.search);
            const groupId = params.get('groupId');

            const [entries, setEntries] = useState([]);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [entryIn, setEntryIn] = useState({ message: '', photo: null, color: '#FAF9F6' });

            const colors = ['#FAF9F6', '#ff85a2', '#f472b6', '#a78bfa', '#60a5fa', '#34d399', '#fbbf24', '#f87171', '#555555'];

            const fetchEntries = () => {
                if (!groupId) return;
                fetch(`${apiRoot}/api/entries?groupId=${groupId}`).then(r => r.json()).then(data => { if(Array.isArray(data)) setEntries(data); });
            };

            useEffect(() => { 
                if (!groupId && !window.location.protocol.startsWith('blob')) { window.location.href = 'index.html'; return; }
                fetchEntries(); 
            }, [groupId]);

            const handleAddEntry = () => {
                if (!entryIn.message && !entryIn.photo) return;
                fetch(`${apiRoot}/api/addEntry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groupId, date: selectedDate.toISOString().split('T')[0], ...entryIn })
                }).then(() => {
                    fetchEntries();
                    setEntryIn({ message: '', photo: null, color: '#FAF9F6' });
                    setIsFormOpen(false);
                });
            };

            const currentEntries = useMemo(() => {
                const ds = selectedDate.toISOString().split('T')[0];
                return entries.filter(e => e.diary_date.includes(ds));
            }, [entries, selectedDate]);

            return (
                <div className="max-w-md mx-auto h-screen bg-white flex flex-col relative overflow-hidden fade-in">
                    {/* ヘッダー: コンパクトに */}
                    <header className="flex justify-between items-center px-6 pt-6 pb-2 shrink-0">
                        <button onClick={() => window.location.href = 'index.html'} className="p-2 text-stone-400 hover:bg-stone-50 rounded-full transition-colors"><Icons.ArrowLeft /></button>
                        <div className="text-center">
                            <h1 className="text-sm font-bold text-stone-300 tracking-[0.3em] uppercase">LUMINA</h1>
                            <p className="text-[10px] text-stone-400 font-mono tracking-tighter">ID: {groupId || 'DEMO'}</p>
                        </div>
                        <div className="w-10"></div>
                    </header>

                    {/* カレンダーセクション: 曜日を明示 */}
                    <section className="px-6 py-2 shrink-0">
                        <div className="flex justify-between items-baseline mb-3">
                            <h2 className="text-2xl font-serif font-bold text-stone-800">2026年 2月</h2>
                        </div>
                        <div className="bg-white rounded-[2rem] shadow-xl border border-stone-50 p-3">
                            <div className="grid grid-cols-7 gap-1 text-center mb-1">
                                {['日','月','火','水','木','金','土'].map((d, i) => (
                                    <span key={d} className={`text-[9px] font-bold ${i===0 ? 'text-red-300' : i===6 ? 'text-blue-300' : 'text-stone-300'}`}>{d}</span>
                                ))}
                            </div>
                            <div className="grid grid-cols-7 gap-1">
                                {Array.from({length: 31}).map((_, i) => {
                                    const ds = `2026-02-${String(i+1).padStart(2,'0')}`;
                                    const dayEntries = entries.filter(e => e.diary_date.includes(ds));
                                    const isSelected = selectedDate.getDate() === i+1;
                                    return (
                                        <div 
                                            key={i} 
                                            onClick={() => setSelectedDate(new Date(2026, 1, i+1))} 
                                            className={`aspect-square relative border border-stone-50 flex flex-col items-center justify-end p-0.5 cursor-pointer transition-all rounded-lg ${isSelected ? 'ring-2 ring-stone-800 bg-stone-50 z-10' : 'hover:bg-stone-50/50'}`}
                                        >
                                            <span className={`absolute top-0.5 left-1 text-[7px] font-bold ${isSelected ? 'text-stone-800' : 'text-stone-200'}`}>{i+1}</span>
                                            <TreeGraphic entries={dayEntries} size="small" />
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </section>

                    {/* メインビジュアライザー: 余白を調整して画面内に収める */}
                    <section className="flex-1 px-6 py-4 flex flex-col overflow-hidden">
                        <h3 className="text-xl font-serif font-bold text-stone-800 mb-2">{selectedDate.toLocaleDateString('ja-JP', {month:'long', day:'numeric', weekday:'short'})}</h3>
                        <div className="relative w-full flex-1 bg-stone-50/40 rounded-[3rem] overflow-hidden border border-stone-100 flex items-end justify-center p-6 shadow-inner">
                            <div className="absolute bottom-6 w-full"><TreeGraphic entries={currentEntries} /></div>
                            <div className="relative z-10 w-full h-full mb-8">
                                {currentEntries.map((item, idx) => (
                                    <div key={item.id || idx} className="absolute item-float" style={{top: `${20+(idx%4)*18}%`, left: `${15+(idx%5)*18}%`, transform: 'translate(-50%, -50%)'}}>
                                        <div className="p-1 bg-white shadow-lg rounded-xl border border-stone-100 relative group">
                                            {item.image_data ? 
                                                <img src={item.image_data} className="w-10 h-10 object-cover rounded-lg group-hover:scale-150 transition-transform" /> :
                                                <div className="w-10 h-10 flex items-center justify-center bg-stone-50 rounded-lg text-[8px] text-stone-300 text-center leading-tight px-1">{item.message}</div>
                                            }
                                            <div className="absolute -bottom-1 -right-1 w-2.5 h-2.5 rounded-full border border-white" style={{backgroundColor: item.color}} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    {/* ハーフシート登録フォーム */}
                    <div className={`fixed inset-0 z-50 pointer-events-none transition-opacity duration-500 ${isFormOpen ? 'bg-stone-900/10 pointer-events-auto opacity-100' : 'opacity-0'}`} onClick={() => setIsFormOpen(false)} />
                    
                    <div className={`fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-stone-100 rounded-t-[3.5rem] shadow-[0_-20px_50px_rgba(0,0,0,0.1)] z-50 transition-transform duration-500 ease-in-out ${isFormOpen ? 'translate-y-0 h-1/2' : 'translate-y-[calc(100%-64px)] h-auto'}`}>
                        {/* ハンドル/トグル */}
                        <button onClick={() => setIsFormOpen(!isFormOpen)} className="w-full h-16 flex flex-col items-center justify-center text-stone-200 hover:text-stone-400 transition-colors">
                            <div className="w-12 h-1 bg-stone-100 rounded-full mb-2" />
                            {!isFormOpen && <span className="text-[10px] font-bold tracking-[0.3em] text-stone-300 uppercase">Memorize</span>}
                        </button>

                        <div className="px-8 pb-10 pt-2 space-y-6 overflow-y-auto no-scrollbar h-[calc(100%-64px)]">
                            {/* カラーパレット */}
                            <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                                {colors.map(c => (
                                    <button 
                                        key={c} 
                                        onClick={() => setEntryIn({...entryIn, color: c})} 
                                        className={`w-8 h-8 rounded-full border shrink-0 transition-all ${entryIn.color === c ? 'ring-2 ring-stone-800 scale-110 shadow-md' : 'border-stone-100'}`} 
                                        style={{backgroundColor: c}} 
                                    />
                                ))}
                            </div>

                            <div className="flex gap-4 items-start">
                                <label className="w-16 h-16 shrink-0 flex items-center justify-center bg-stone-50 rounded-[1.5rem] text-stone-300 border shadow-sm cursor-pointer hover:bg-stone-100 transition-colors">
                                    <Icons.Camera />
                                    <input type="file" className="hidden" accept="image/*" onChange={(e) => { 
                                        const r = new FileReader(); 
                                        r.onload = () => setEntryIn({...entryIn, photo: r.result}); 
                                        r.readAsDataURL(e.target.files[0]); 
                                    }} />
                                </label>
                                <div className="flex-1 flex flex-col gap-4">
                                    <textarea 
                                        placeholder="今、この瞬間の想いを..." 
                                        rows={4} 
                                        className="w-full bg-stone-50 rounded-[1.5rem] p-4 text-sm outline-none resize-none border border-stone-100 shadow-inner" 
                                        value={entryIn.message} 
                                        onChange={e => setEntryIn({...entryIn, message: e.target.value})} 
                                    />
                                    <button 
                                        onClick={handleAddEntry} 
                                        disabled={!entryIn.message && !entryIn.photo}
                                        className="w-full py-4 bg-stone-800 text-white rounded-[1.5rem] flex items-center justify-center font-bold shadow-lg active:scale-95 transition-all disabled:bg-stone-100"
                                    >
                                        想い出を庭園に飾る
                                    </button>
                                </div>
                            </div>
                            
                            {entryIn.photo && (
                                <div className="relative inline-block mt-2 fade-in">
                                    <img src={entryIn.photo} className="w-full aspect-video object-cover rounded-[2rem] border-4 border-white shadow-xl" />
                                    <button onClick={() => setEntryIn({...entryIn, photo: null})} className="absolute -top-2 -right-2 bg-stone-800 text-white rounded-full p-2 border-2 border-white shadow-lg">✕</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
